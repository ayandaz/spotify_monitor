<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Spotify Monitor</title>
  <link rel="stylesheet" href="web/styles.css">
</head>
<body>

<h1>Spotify Monitor – Known Releases</h1>

<!-- Album grid -->
<div class="album-grid" id="albums"></div>

<hr>

<button class="primary" onclick="checkNow()">Check Now</button>
<p id="check-status"></p>

<!-- Add albums -->
<h2>Add Albums to Whitelist</h2>

<div id="fields-container">
  <div class="field-wrapper">
    <input type="text" placeholder="Enter album ID" class="album-field">
    <button type="button" onclick="addField()">+</button>
  </div>
</div>

<button class="primary" onclick="submitAlbums()">Submit</button>

<div id="results"></div>
<hr>
<h2>Spotify Artist Links</h2>

<div class="links">
  <a
    href="https://artists.spotify.com/c/artist/69eRfY40RjSFrZOToECdiS/home"
    target="_blank"
    rel="noopener"
  >
    Ayan Das
  </a>

  <a
    href="https://artists.spotify.com/c/content-mismatch"
    target="_blank"
    rel="noopener"
  >
    Report Wrong Content
  </a>
</div>


<script>
async function loadAlbums() {
  const container = document.getElementById("albums");
  container.innerHTML = "";

  const res = await fetch("/api/list_known");
  const albums = await res.json();

  albums.forEach(a => {
    const div = document.createElement("div");
    div.className = "album";
    div.innerHTML = `
      <img src="${a.image}" alt="${a.name}">
      <strong>${a.name}</strong>
      <small>${a.release_date}</small>
      <a href="${a.spotify_url}" target="_blank">Listen</a>
      <button class="delete-btn" onclick="deleteAlbum('${a.id}')">Delete</button>
    `;
    container.appendChild(div);
  });
}

function addField() {
  const container = document.getElementById("fields-container");
  const wrapper = document.createElement("div");
  wrapper.className = "field-wrapper";

  wrapper.innerHTML = `
    <input type="text" placeholder="Enter album ID" class="album-field">
    <button type="button" onclick="this.parentElement.remove()">−</button>
  `;

  container.appendChild(wrapper);
}

async function submitAlbums() {
  const results = document.getElementById("results");
  results.innerHTML = "";

  const ids = Array.from(document.querySelectorAll(".album-field"))
    .map(i => i.value.trim())
    .filter(Boolean);

  if (!ids.length) return;

  const res = await fetch("/api/add_known", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ album_ids: ids })
  });

  const data = await res.json();

  if (res.ok) {
    results.innerHTML = `<p class="success">${data.message}</p>`;
  } else {
    results.innerHTML = `<p class="error">${data.error}</p>`;
  }

  loadAlbums();
}

async function deleteAlbum(id) {
  if (!confirm("Remove this album from known releases?")) return;

  await fetch("/api/delete_known", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ album_ids: [id] })
  });

  loadAlbums();
}

async function checkNow() {
  const status = document.getElementById("check-status");
  status.textContent = "Checking Spotify…";

  try {
    const res = await fetch("/api/monitor");
    const data = await res.json();

    if (res.ok) {
      status.textContent = `Checked. Alerts sent: ${data.alerts_sent}`;
    } else {
      status.textContent = "Monitor failed";
    }
  } catch (e) {
    status.textContent = "Error calling monitor";
  }
}

loadAlbums();
</script>

</body>
</html>
