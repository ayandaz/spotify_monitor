<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Spotify Monitor</title>
  <link rel="stylesheet" href="web/styles.css" />
</head>
<body>

  <header class="page-header">
    <div>
      <h1>Spotify Monitor</h1>
      <p>
        Detect and manage unrecognized releases under your artist profile
      </p>
    </div>
  </header>


  <!-- Known Releases -->
  <section class="card">
    <h2>Known Releases</h2>
    <div class="album-grid" id="albums"></div>
  </section>

  <!-- Check Now / Unrecognized -->
  <section class="card">
    <div style="display:flex; align-items:center; justify-content:space-between; gap:16px;">
      <h2 style="margin:0;">Unrecognized Releases</h2>
      <button class="primary" onclick="checkNow()">Check Now</button>
    </div>

    <p id="check-status"></p>

    <!-- Empty by default, populated after Check Now -->
    <div
      id="check-results"
      class="album-grid"
      style="margin-top:18px;"
    ></div>
  </section>

  <!-- Add Albums -->
  <section class="card">
    <h2>Add Albums to Whitelist</h2>

    <div id="fields-container">
      <div class="field-wrapper">
        <input type="text" placeholder="Spotify album ID" class="album-field"/>
        <button type="button" onclick="addField()">+</button>
      </div>
    </div>
    <button class="primary" onclick="submitAlbums()">Submit</button>
    <div id="results"></div>
  </section>

  <!-- Artist Links -->
  <section class="card">
    <h2>Spotify Artist Links</h2>
    <div class="links">
      <a
        href="https://artists.spotify.com/c/artist/69eRfY40RjSFrZOToECdiS/home"
        target="_blank"
        rel="noopener"
      >
        Artist Home
      </a>

      <a
        href="https://artists.spotify.com/c/content-mismatch"
        target="_blank"
        rel="noopener"
      >
        Report Wrong Content
      </a>
    </div>
  </section>


<script>
async function loadAlbums() {
  const container = document.getElementById("albums");
  container.innerHTML = "";

  const res = await fetch("/api/list_known");
  const albums = await res.json();

  albums.forEach(a => {
    const div = document.createElement("div");
    div.className = "album";
    div.innerHTML = `
      <img src="${a.image}" alt="${a.name}">
      <strong>${a.name}</strong>
      <small>${a.release_date}</small>
      <a href="${a.spotify_url}" target="_blank">Listen</a>
      <button class="delete-btn" onclick="deleteAlbum('${a.id}')">Delete</button>
    `;
    container.appendChild(div);
  });
}

function addField() {
  const container = document.getElementById("fields-container");
  const wrapper = document.createElement("div");
  wrapper.className = "field-wrapper";

  wrapper.innerHTML = `
    <input type="text" placeholder="Enter album ID" class="album-field">
    <button type="button" onclick="this.parentElement.remove()">‚àí</button>
  `;

  container.appendChild(wrapper);
}

async function submitAlbums() {
  const results = document.getElementById("results");
  results.innerHTML = "";

  const ids = Array.from(document.querySelectorAll(".album-field"))
    .map(i => i.value.trim())
    .filter(Boolean);

  if (!ids.length) return;

  const res = await fetch("/api/add_known", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ album_ids: ids })
  });

  const data = await res.json();

  if (res.ok) {
    results.innerHTML = `<p class="success">${data.message}</p>`;
  } else {
    results.innerHTML = `<p class="error">${data.error}</p>`;
  }

  loadAlbums();
}

async function deleteAlbum(id) {
  if (!confirm("Remove this album from known releases?")) return;

  await fetch("/api/delete_known", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ album_ids: [id] })
  });

  loadAlbums();
}

async function checkNow() {
  const status = document.getElementById("check-status");
  const container = document.getElementById("check-results");

  status.textContent = "Checking Spotify‚Ä¶";
  container.innerHTML = "";

  try {
    const res = await fetch("/api/check_now");
    const albums = await res.json();

    if (!albums.length) {
      status.textContent = "No unrecognized releases found";
      return;
    }

    status.textContent = `${albums.length} unrecognized releases`;

    albums.forEach(a => {
      const div = document.createElement("div");
      div.className = "album";

      div.innerHTML = `
        <img src="${a.image}">
        <strong>${a.name}</strong>
        <small>${a.release_date}</small>
        <div class="copy-row">
          <a href="${a.spotify_url}" target="_blank">Listen</a>
          <span class="copy" onclick="copyToClipboard(this, 'SPOTIFY_URL')">üóê</span>
          <span class="copied">Copied!</span>
        </div>
      `;

      container.appendChild(div);
    });

  } catch (e) {
    status.textContent = "Error checking releases";
  }
}

function copy(text) {
  navigator.clipboard.writeText(text);
}

async function copyToClipboard(el, text) {
  try {
    await navigator.clipboard.writeText(text);

    const copied = el.nextElementSibling;
    copied.classList.add("show");

    setTimeout(() => {
      copied.classList.remove("show");
    }, 1200);

  } catch (err) {
    console.error("Copy failed", err);
  }
}


loadAlbums();
</script>

</body>
</html>
