<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Spotify Monitor</title>
  <link rel="stylesheet" href="/styles.css">
</head>
<body>

<h1>Spotify Monitor â€“ Known Releases</h1>

<!-- Album grid -->
<div class="album-grid" id="albums"></div>

<hr>

<!-- Add albums -->
<h2>Add Albums to Whitelist</h2>

<div id="fields-container">
  <div class="field-wrapper">
    <input type="text" placeholder="Enter album ID" class="album-field">
    <button type="button" onclick="addField()">+</button>
  </div>
</div>

<button class="primary" onclick="submitAlbums()">Submit</button>

<div id="results"></div>

<script>
async function loadAlbums() {
  const container = document.getElementById("albums");
  container.innerHTML = "";

  const res = await fetch("/api/list_known");
  const albums = await res.json();

  albums.forEach(a => {
    const div = document.createElement("div");
    div.className = "album";
    div.innerHTML = `
      <img src="${a.image}" alt="${a.name}">
      <strong>${a.name}</strong>
      <small>${a.release_date}</small>
      <a href="${a.spotify_url}" target="_blank">Listen</a>
      <button class="delete-btn" onclick="deleteAlbum('${a.id}')">ðŸ—‘ Delete</button>
    `;
    container.appendChild(div);
  });
}

function addField() {
  const container = document.getElementById("fields-container");
  const wrapper = document.createElement("div");
  wrapper.className = "field-wrapper";

  wrapper.innerHTML = `
    <input type="text" placeholder="Enter album ID" class="album-field">
    <button type="button" onclick="this.parentElement.remove()">âˆ’</button>
  `;

  container.appendChild(wrapper);
}

async function submitAlbums() {
  const results = document.getElementById("results");
  results.innerHTML = "";

  const ids = Array.from(document.querySelectorAll(".album-field"))
    .map(i => i.value.trim())
    .filter(Boolean);

  if (!ids.length) return;

  const res = await fetch("/api/add_known", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ album_ids: ids })
  });

  const data = await res.json();

  if (res.ok) {
    results.innerHTML = `<p class="success">${data.message}</p>`;
  } else {
    results.innerHTML = `<p class="error">${data.error}</p>`;
  }

  loadAlbums();
}

async function deleteAlbum(id) {
  if (!confirm("Remove this album from known releases?")) return;

  await fetch("/api/delete_known", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ album_ids: [id] })
  });

  loadAlbums();
}

loadAlbums();
</script>

</body>
</html>
